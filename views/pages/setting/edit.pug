extends ../../layout
block css
    style.
        textarea {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            overflow: auto;
        }
block content
    .row
        .col-12
            .card
                .card-header
                    h3.card-title=website_name
                        |  - 
                        b Article & Section Filters 
                        img(src=website_icon_url, width="20")
                    .card-tools
                        button(type="button", class="btn btn-tool", data-card-widget="maximize")
                            i.fas.fa-expand
                        button(type="button", class="btn btn-tool", data-card-widget="collapse")
                            i.fas.fa-minus
                .card-body
                    form#article-section-filters
                        .row
                            .col-sm-12
                                label(for="section_filters") Section Filters
                                textarea#section_filters.form-control(name="section_filters", cols="30", rows="10")
                                    | {
                                    |    "includes": [],
                                    |    "excludes": ["\\/tags\\/", "\\/tag\\/", "\\/search\\/", "\\/labels\\/", "\\/label\\/"]
                                    | }

                            .col-sm-12
                                label(for="article_filters") Article Filters
                                textarea#article_filters.form-control(name="article_filters", cols="30", rows="10")
                                    | {
                                    |    "includes": [],
                                    |    "excludes": ["\\/tags\\/", "\\/tag\\/", "\\/search\\/", "\\/labels\\/", "\\/label\\/"]
                                    | }
                            
                            .col-sm-12
                                .input-group
                                    span.input-group-prepend
                                        span.input-group-text.bg-info
                                            i.fas.fa-globe
                                    input#url.form-control(type="url", name="url", placeholder="Url", value=website_url)
                                    span.input-group-append
                                        select.form-control(id="request_source", name="request_source")
                                            option(value="request", selected=(request_source === 'request') ? true : false) Request
                                            option(value="cloudscraper", selected=(request_source === 'cloudscraper') ? true : false) Cloud Scraper
                                    span.input-group-append
                                        button.btn.btn-default.bg-info(type="button", id="btnTest") Test Filters
                .card-footer#result-for-filters
                .overlay(style="display:none;")
                    i(class="fas fa-2x fa-sync-alt fa-spin")

    .row
        .col-12
            .card
                .card-header
                    h3.card-title=website_name
                        |  - 
                        b Scraper Settings
                    .card-tools
                        button(type="button", class="btn btn-tool", data-card-widget="maximize")
                            i.fas.fa-expand
                        button(type="button", class="btn btn-tool", data-card-widget="collapse")
                            i.fas.fa-minus
                .card-body
                    form#scraper-settings
                        .row
                            label(class="col-sm-2 col-form-label", for="is_using_selectors") Is Using Selectors?
                            .col-sm-6
                                .custom-control.custom-switch
                                    input#is_using_selectors(type="checkbox", name="is_using_selectors", class="custom-control-input", checked=(is_using_selectors) ? true  : false)
                                    label(for="is_using_selectors", class="custom-control-label") No or Yes                       
                            
                            .col-sm-12
                                label(for="selectors") Website Selectors
                                textarea#selectors.form-control(name="selectors", cols="30", rows="10")
                                    | {
                                    |    "title": [
                                    |         {
                                    |             "selector": "element|class|id|pseudo-class|selector",
                                    |             "attribute": null,
                                    |             "ignore_tags": [],
                                    |             "replace": []
                                    |         }
                                    |     ],
                                    |     "publish": [
                                    |         {
                                    |             "selector": "element|class|id|pseudo-class|selector",
                                    |             "attribute": null,
                                    |             "ignore_tags": [],
                                    |             "replace": []
                                    |         }
                                    |     ],
                                    |     "author": [
                                    |         {
                                    |             "selector": "element|class|id|pseudo-class|selector",
                                    |             "attribute": null,
                                    |             "ignore_tags": [],
                                    |             "replace": []
                                    |         }
                                    |     ],
                                    |     "section": [
                                    |         {
                                    |             "selector": "element|class|id|pseudo-class|selector",
                                    |             "attribute": null,
                                    |             "ignore_tags": [],
                                    |             "replace": []
                                    |         }
                                    |     ],
                                    |     "body": [
                                    |         {
                                    |             "selector": "element|class|id|pseudo-class|selector",
                                    |             "attribute": null,
                                    |             "ignore_tags": [],
                                    |             "replace": []
                                    |         }
                                    |     ],
                                    |     "image": [
                                    |         {
                                    |             "selector": "element|class|id|pseudo-class|selector",
                                    |             "attribute": null,
                                    |             "ignore_tags": [],
                                    |             "replace": []
                                    |         }
                                    |     ],
                                    |     "video": [
                                    |         {
                                    |             "selector": "element|class|id|pseudo-class|selector",
                                    |             "attribute": null,
                                    |             "ignore_tags": [],
                                    |             "replace": []
                                    |         }
                                    |     ]
                                    | }    
                            
                            label(class="col-sm-2 col-form-label", for="is_using_snippets") Is Using Code Snippet?
                            .col-sm-6
                                .custom-control.custom-switch
                                    input#is_using_snippets(type="checkbox", name="is_using_snippets", class="custom-control-input", checked=(is_using_snippets) ? true  : false)
                                    label(for="is_using_snippets", class="custom-control-label") No or Yes 

                            .col-sm-12
                                label(for="code_snippet") Website Snippet
                                textarea#code_snippet.form-control(name="code_snippet", cols="30", rows="10", readonly)
                                    | // this will be configure later
                                    | class Article {
                                    |     constructor($wrapper, $string, $moment, $article_url){
                                    |         this._cheerio = $wrapper;
                                    |         this._string = $string;
                                    |         this._moment = $moment;
                                    |         this._url = $article_url;
                                    |     }
                                    | }
                                    | 
                                    | //Dont modify this block
                                    | Article.prototype.ENTITY = function(){
                                    |     return this._cheerio
                                    | }
                                    | 
                                    | //Dont modify this block
                                    | Article.prototype.STRING = function(){
                                    |     return this._string
                                    | }
                                    | 
                                    | //Dont modify this block
                                    | Article.prototype.MOMENT = function(){
                                    |     return this._moment
                                    | }
                                    | 
                                    | // You can modify this function
                                    | Article.prototype.ARTICLE_TITLE = async function(){
                                    |     const $ = this.ENTITY()
                                    |     const S = this.STRING()
                                    |     const p = new Promise(async (resolve, reject) => {
                                    |         try{
                                    |             // insert your code here
                                    |             let selectors = [
                                    |                {
                                    |                   "selector": "title",
                                    |                   "attribute": null
                                    |                },
                                    |                {
                                    |                   "selector": "meta[property=\"og:title\"]",
                                    |                   "attribute": "content"
                                    |                },
                                    |                {
                                    |                   "selector": "article header .entry-title",
                                    |                   "attribute": null
                                    |                },
                                    |                {
                                    |                   "selector": "article header .post-title",
                                    |                   "attribute": null
                                    |                }
                                    |             ]
                                    |
                                    |             let findReplaces = [] // {find: "string or regex", replace:""}
                                    |
                                    |             let select = (selectors.length > 0) ? selectors.filter(v=>$(v.selector).length > 0) : reject('(Title) No selectors')
                                    |             let selector = select.splice(-1)[0]
                                    |             let title = (selector.attribute) ? $(selector.selector).eq(0).attr(selector.attribute) : $(selector.selector).eq(0).text().trim()
                                    |
                                    |             if(findReplaces.length > 0){
                                    |               for(let i = 0; i < findReplaces.length; i++){
                                    |                   let fr = findReplaces[i]
                                    |                   title = S(title).replaceAll(fr.find, fr.replace).s.trim()
                                    |               }
                                    |             }
                                    |
                                    |             if(!title){
                                    |                  reject('Missing title.')
                                    |             }else{
                                    |                  resolve(title)
                                    |             }
                                    |         }catch(error){
                                    |             reject(error)
                                    |         }
                                    |     })
                                    |     return p
                                    | }
                                    | 
                                    | Article.prototype.ARTICLE_PUBLISH = async function(){
                                    |     const $ = this.ENTITY()
                                    |     const p = new Promise(async (resolve, reject) => {
                                    |         try{
                                    |             // insert your code here
                                    |             let selectors = [
                                    |               {
                                    |                   "selector": "meta[property=\"article:published_time\"]",
                                    |                   "attribute": "content"
                                    |               }
                                    |             ]
                                    |            
                                    |             let select = (selectors.length > 0) ? selectors.filter(v=>$(v.selector).length > 0) : reject('(Date) No selectors.')
                                    |             let selector = select.splice(-1)[0]
                                    |             let date = (selector.attribute) ? $(selector.selector).eq(0).attr(selector.attribute) : $(selector.selector).eq(0).text().trim()
                                    |
                                    |             if(!date){
                                    |                   reject('Missing date.')
                                    |             }else{
                                    |                   resolve(new Date(date))
                                    |             }
                                    |         }catch(error){
                                    |             reject(error)
                                    |         }
                                    |     })
                                    |     return p
                                    | }
                                    | 
                                    | Article.prototype.ARTICLE_AUTHOR = async function(){
                                    |     const $ = this.ENTITY()
                                    |     const p = new Promise(async (resolve, reject) => {
                                    |         try{
                                    |             // insert your code here, author is array value
                                    |             let authors = []
                                    |             let selectors = []
                                    |
                                    |             if(selectors.length > 0){
                                    |               let select = selectors.filter(v=>$(v.selector).length > 0)
                                    |               if(select.length > 0){
                                    |                   let selector = select.splice(-1)[0]
                                    |                   let _authors = (selector.attribute) ? $(selector.selector).map(function(){ return $(this).attr(selector.attribute) }).get().filter(v=>v) : $(selector.selector).map(function(){
                                    |                       return $(this).text().trim()
                                    |                   }).get().filter(v=>v)
                                    |                   authors = _authors
                                    |               }
                                    |             }                
                                    |
                                    |             let _uniqAuthors = (authors.length > 0) ? Array.from(new Set(authors)) : ["No - Author"]
                                    |             resolve(_uniqAuthors)
                                    |         }catch(error){
                                    |             reject(error)
                                    |         }
                                    |     })
                                    |     return p
                                    | }
                                    | 
                                    | Article.prototype.ARTICLE_SECTION = async function(){
                                    |     const $ = this.ENTITY()
                                    |     const p = new Promise(async (resolve, reject) => {
                                    |         try{
                                    |             // insert your code here, section is array value
                                    |             let sections = []
                                    |             let selectors = []
                                    |
                                    |             if(selectors.length > 0){
                                    |               let select = selectors.filter(v=>$(v.selector).length > 0)
                                    |               if(select.length > 0){
                                    |                   let selector = select.splice(-1)[0]
                                    |                   let _sections = (selector.attribute) ? $(selector.selector).map(function(){ return $(this).attr(selector.attribute) }).get().filter(v=>v) : $(selector.selector).map(function(){
                                    |                       return $(this).text().trim()
                                    |                   }).get().filter(v=>v)
                                    |                   sections = _sections
                                    |               }
                                    |             }
                                    |
                                    |             let _uniqSections = (sections.length > 0) ? Array.from(new Set(sections)) : ["#{website_category}"]
                                    |             resolve(_uniqSections)
                                    |         }catch(error){
                                    |             reject(error)
                                    |         }
                                    |     })
                                    |     return p
                                    | }
                                    | 
                                    | Article.prototype.ARTICLE_HTML = async function(){
                                    |     const $ = this.ENTITY()
                                    |     const p = new Promise(async (resolve, reject) => {
                                    |         try{
                                    |             // insert your code here
                                    |             let ignoreTags = []
                                    |             ignoreTags.map(v=>$(v).remove())
                                    |             let selector = ''
                                    |             let html = $(selector).map(function(){
                                    |                      return $(this)
                                    |             }).get().join('')
                                    |             resolve(html)
                                    |         }catch(error){
                                    |             reject(error)
                                    |         }
                                    |     })
                                    |     return p
                                    | }
                                    | 
                                    | Article.prototype.ARTICLE_TEXT = async function(){
                                    |     const $ = this.ENTITY()
                                    |     const S = this.STRING()
                                    |     const textFromTitle = await this.ARTICLE_TITLE()
                                    |     const p = new Promise(async (resolve, reject) => {
                                    |         try{
                                    |             // insert your code here
                                    |             let ignoreTags = []
                                    |             ignoreTags.map(v=>$(v).remove())
                                    |             let selectors = [
                                    |               {
                                    |                   "selector": "article p",
                                    |                   "attribute": null
                                    |               },
                                    |               {
                                    |                   "selector": "article .entry-content p",
                                    |                   "attribute": null
                                    |               },
                                    |               {
                                    |                   "selector": "article .post-content p",
                                    |                   "attribute": null
                                    |               },
                                    |               {
                                    |                   "selector": "article .post-body p",
                                    |                   "attribute": null
                                    |               }
                                    |             ]
                                    |             let findReplaces = [] // {find: "string or regex", replace:""}
                                    |             let select = selectors.filter(v=>$(v.selector).length > 0)
                                    |             let selector = select.splice(-1)[0]
                                    |             let text = (selector) ? $(selector.selector).map(function(){
                                    |                        return S($(this).text()).stripTags().s.trim()
                                    |             }).get().join('\n\n') : ''
                                    |
                                    |             let textContent = (text.length > 0) ? text : textFromTitle
                                    |
                                    |             if(findReplaces.length > 0){
                                    |               for(let i = 0; i < findReplaces.length; i++){
                                    |                   let fr = findReplaces[i]
                                    |                   textContent = S(textContent).replaceAll(fr.find, fr.replace).s.trim()
                                    |               }
                                    |             }
                                    |
                                    |             if(!textContent){
                                    |                  reject('Missing text.')
                                    |             }else{
                                    |                  resolve(textContent)
                                    |             }
                                    |         }catch(error){
                                    |             reject(error)
                                    |         }
                                    |     })
                                    |     return p
                                    | }
                                    | 
                                    | Article.prototype.ARTICLE_IMAGE = async function(){
                                    |     const $ = this.ENTITY()
                                    |     const p = new Promise(async (resolve, reject) => {
                                    |         try{
                                    |             // insert your code here, section is array value
                                    |             let images = []
                                    |             let selectors = [
                                    |               {
                                    |                   "selector": "meta[property=\"og:image\"]",
                                    |                   "attribute": "content"
                                    |               },
                                    |               {
                                    |                   "selector": "article header img",
                                    |                   "attribute": "src"
                                    |               },
                                    |               {
                                    |                   "selector": "article .entry-content img",
                                    |                   "attribute": "src"
                                    |               },
                                    |               {
                                    |                   "selector": "article .post-content img",
                                    |                   "attribute": "src"
                                    |               },
                                    |               {
                                    |                   "selector": "article .post-body img",
                                    |                   "attribute": "src"
                                    |               }
                                    |             ]
                                    |
                                    |             if(selectors.length > 0){
                                    |               let select = selectors.filter(v=>$(v.selector).length > 0)
                                    |               if(select.length > 0){
                                    |                   let selector = select.splice(-1)[0]
                                    |                   let _images = (selector.attribute) ? $(selector.selector).map(function(){ return $(this).attr(selector.attribute) }).get().filter(v=>v) : $(selector.selector).map(function(){
                                    |                       return $(this).text().trim()
                                    |                   }).get().filter(v=>v)
                                    |                   images = _images
                                    |               }
                                    |             }
                                    |
                                    |             let _uniqImages = (images.length > 0) ? Array.from(new Set(images)) : []
                                    |             resolve(_uniqImages)
                                    |         }catch(error){
                                    |             reject(error)
                                    |         }
                                    |     })
                                    |     return p
                                    | }
                                    | 
                                    | Article.prototype.ARTICLE_VIDEO = async function(){
                                    |     const $ = this.ENTITY()
                                    |     const p = new Promise(async (resolve, reject) => {
                                    |         try{
                                    |             // insert your code here, section is array value
                                    |             let videos = []
                                    |             let selectors = []
                                    |
                                    |             if(selectors.length > 0){
                                    |               let select = selectors.filter(v=>$(v.selector).length > 0)
                                    |               if(select.length > 0){
                                    |                   let selector = select.splice(-1)[0]
                                    |                   let _videos = (selector.attribute) ? $(selector.selector).map(function(){ return $(this).attr(selector.attribute) }).get().filter(v=>v) : $(selector.selector).map(function(){
                                    |                       return $(this).text().trim()
                                    |                   }).get().filter(v=>v)
                                    |                   videos = _videos
                                    |               }
                                    |             }
                                    |
                                    |             let _uniqVideos = (videos.length > 0) ? Array.from(new Set(videos)) : []
                                    |             resolve(_uniqVideos)
                                    |         }catch(error){
                                    |             reject(error)
                                    |         }
                                    |     })
                                    |     return p
                                    | }
                                    | 
                                    | 
                                    | return Article;

                            .col-sm-12
                                .input-group
                                    span.input-group-prepend
                                        span.input-group-text.bg-info
                                            i.fas.fa-globe
                                    input#url2.form-control(type="url", name="url2", placeholder="Article Url")
                                    span.input-group-append
                                        select.form-control(id="request_source2", name="request_source2")
                                            option(value="request", selected=(request_source === 'request') ? true : false) Request
                                            option(value="cloudscraper", selected=(request_source === 'cloudscraper') ? true : false) Cloud Scraper
                                    span.input-group-append
                                        button.btn.btn-default.bg-info(type="button", id="btnParseArticle") Parse Article
                .card-footer#result-for-article
                .overlay(style="display:none;")
                    i(class="fas fa-2x fa-sync-alt fa-spin")

    .row
        .col-sm-12
            button#btnUpdateWebsite(type="button", class="btn btn-info") Save Changes
block js
    script.
        const userData = JSON.parse('!{JSON.stringify(session)}')
        const user = userData.user.acc_first_name+' '+userData.user.acc_last_name
    script(src="/admin-lte-3/javascripts/ace/src-noconflict/ace.js")
    script(src="/admin-lte-3/javascripts/setting/edit.js")
    script.
        const id = '#{_id}'
        const website_url = '#{website_url}'
        const needs_search_params = '#{needs_search_params}'
        const needs_https = '#{needs_https}'
        const needs_endslash = '#{needs_endslash}'
        const sections = JSON.parse(`!{JSON.stringify(main_sections)}`)
        const alexa = JSON.parse(`!{JSON.stringify(alexa_rankings)}`)
        const global_rank = alexa.global
        const local_rank = alexa.local
        const website_cost = parseInt('#{website_cost}')
        editWebsite(ace)